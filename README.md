# LIBEFP

## Overview

The Effective Fragment Potential (EFP) method allows one to describe large
molecular systems by replacing chemically inert part of a system by a set of
Effective Fragments while performing regular _ab initio_ calculation on the
chemically active part [1-8]. The LIBEFP library is a full implementation of
the EFP method. It allows users to easily incorporate EFP support into their
favourite quantum chemistry package. 
LIBEFP is interfaced to [Q-Chem](http://www.q-chem.com) and
[PSI4](http://www.psicode.org) for QM/EFP calculations.

Detailed description of methods and algorithms can be found in two LIBEFP
papers:

- [Kaliman and Slipchenko, JCC 2013](http://dx.doi.org/10.1002/jcc.23375)
- [Kaliman and Slipchenko, JCC 2015](http://dx.doi.org/10.1002/jcc.23772)

Documentation, tutorials, and a full EFP bibliography can be found at the official 
[EFP website](https://libefp2.github.io/index.html).

## Getting source code

The latest release can be downloaded
[here](https://github.com/libefp2/libefp/releases).

## Installation

**See [README-torch.md](README-torch.md) for the up-to-date installation instructions!
For additional CMake instructions, see [README-cmake.md](README-cmake.md).
The section below is outdated.**

To build LIBEFP from source you need the following:

- C compiler (with C99 standard and OpenMP support)

- POSIX complaint make utility (BSD make or GNU make will work) or CMake

- BLAS/LAPACK libraries (required when linking with LIBEFP)

If you are going to compile EFPMD program (required for tests):

- Fortran 77 compiler

First, copy the configuration file which suits you from `config` directory to
the top source code directory. Rename the file to `config.inc` and edit it
according to your needs. All available options are explained in comments.
Defaults usually work well, but you may need to change the `MYLIBS` variable to
link with additional libraries required by your setup. You may also need to add
additional include directories to `MYCFLAGS` (using -I flag) or library search
path to `MYLDFLAGS` (using -L flag).

To compile issue:

    make

If you only need the library you can use:

    make libefp

To run the test suite (optional) issue:

    make check
    make checkomp    # to test OpenMP parallel code
    make checkmpi    # to test MPI parallel code

Finally, to install everything issue:

    make install

## Documentation

For a detailed documentation, tutorials, and EFP bibliography check out 
the official [EFP website](https://libefp2.github.io/index.html).

The description of public [LIBEFP API](https://libefp2.github.io/doxygen_html/index.html).

Step-by-step instructions for interfacing LIBEFP to electronic structure codes are provided in 
[QM/EFP interface](interface/readme.txt). 

Fortran bindings to LIBEFP are available in
[interface/efp.f90](interface/efp.f90).

## EFPMD

The EFPMD program is a molecular simulation package based on LIBEFP.
It supports EFP-only molecular simulations such as geometry optimization
and molecular dynamics. EFPMD is a part of the LIBEFP distribution.
See [EFPMD manual](https://libefp2.github.io/efpmd.html) for more information.

## Parallel scaling

Parallel scaling of LIBEFP is shown below. Benchmarks were done on the
SDSC Gordon supercomputer using EFPMD.

![parallel.png](efpmd/parallel.png)

## How to create custom EFP fragment types

LIBEFP comes with a library of ready-to-use fragments. If you decide to
generate custom fragment parameters follow the instructions below.

LIBEFP uses EFP potential files in format generated by GAMESS quantum
chemistry package (see http://www.msg.ameslab.gov/gamess/). A version of GAMESS
from August 11, 2011 is the currently a recommended and tested version. A set
of pre-generated library fragments are available in the `fraglib` directory. If
you want to generate parameters for custom fragments you should create GAMESS
makefp job input similar to the `fraglib/makefp.inp` file. Using this input
file as a template you can create EFP parameters for arbitrary fragment types.

After you created `.efp` file using GAMESS you should rename the fragment by
replacing `$FRAGNAME` with your name of choice (e.g. rename `$FRAGNAME` to
`$MYH2O`).

For a complete description of EFP data file format consult FRAGNAME section in
GAMESS manual (see http://www.msg.ameslab.gov/gamess/).

More information can be found in [How to create EFP parameters](https://libefp2.github.io/html/parameters.html).

## Information for code contributors

- The main design principle for the LIBEFP library is Keep It Simple.
  All code should be easy to read and to understand. It should be easy to
  integrate the library into programs written in different programming
  languages. So the language of choice is C and no fancy Object-Oriented
  hierarchies.

- Be consistent in coding style when adding new code. Consistency is more
  important than particular coding style. Use descriptive names for variables
  and functions. The bigger the scope of the symbol the longer its name should
  be. Look at the sources and maintain similar style for new code.

- As with most quantum chemistry methods, EFP can require large amounts of
  memory. The guideline for developers here is simple: ALWAYS check for memory
  allocation errors in your code and return `EFP_RESULT_NO_MEMORY` on error.

- The code is reentrant which means that it is safe to use two different `efp`
  objects from two different threads. NEVER use mutable global state as it
  will break this. Store all mutable data in the `efp` object.

- Use `-Wall -Wextra -Werror` flags to make sure that compilation produces no
  warnings. Use `make check` to make sure that the code passes test cases.

## References

A complete list of references to the EFP method can be found [here](https://libefp2.github.io/papers.html#).